---
title     : 浏览器下文件压缩与解压
date      : 2022-01-12 20: 20: 31
author    : RuiLin Dong
permalink : /read/20220112082041
categories: 
  - JavaScript
tags: 
  - JavaScript
  - 文件处理
---
  最近需要解决一个云组件的导入导出需求，需要导出图片和json数据，导入时需要解压并上传数据。了解后决定通过 [jszip](https://github.com/Stuk/jszip) 和 [file-saver](https://github.com/eligrey/FileSaver.js/) 实现。
## 导出

```js
import { saveAs } from 'file-saver';
import JSZip from 'jszip';

const export = async () => {
    const zip = new JSZip();
    const img = zip.folder("images");
    zip.file("fileName.json", jsonData);
    const content = await zip.generateAsync({ type: "blob" })
    // 下载
    saveAs(content, "data.zip");
};
/**
 *  - data.zip 
 *    - images
 *      - a.png
 *      - b.png
 *    - filName.json
 */
```
这里的图片以 base64 的编码导出。
```typescript
export const getBase64Img = (src: string): Promise<string> => {
    return new Promise<string>((resolve, reject) => {
        let   canvas = document.createElement("canvas");
        const ctx    = canvas.getContext("2d");
        const img    = new Image();
        try {
            img.crossOrigin = "Access-Control-Allow-Origin";
            img.onload      = function () {
                canvas.height = img.height;
                canvas.width  = img.width;
                ctx?.drawImage(img, 0, 0);
                const dataUrl        = canvas.toDataURL("image/png");
                const deleDataHeader = dataUrl.split(",")[1];
                resolve(deleDataHeader);
            };
            img.src = src;
        } catch (error) {
            reject(String(error));
        }
    });
};
```
## 导入
导入是以 antd 的 upload 组件使用为例，
```js
const customRequest = async (options) => {
  const { file } = options;
  const JsZip = new JSZip();
  const reader = new FileReader();
  const zip = await JsZip.loadAsync(file);
  for (let zobj of Object.values(zip.files)) {
    const nameArr = zobj.name.split(".");
    const formate = nameArr[nameArr.length - 1]?.toLowerCase();
    if (formate === "json") {
      const zBlob = await zobj.async("blob");
      reader.readAsText(zBlob);
      reader.onload = (data) => {
        if (typeof data.target?.result === "string") {
          const jsonData = JSON.parse(data.target.result);
        }
      };

    if (zobj.dir === false && zobj.name.includes("images/")) {
        const zBlob = await zobj.async("blob");
        // 可以将 img 改为 file 对象
        const zfile = new File([zBlob], zobj.name, {
          lastModified: zobj.date.getTime(),
          type: "image/imgName.png",
        });
      }
    }
  }
};


```
## 结语
后面可能还会遇到类似的需求，所以写了这篇博客，主要以代码为主，只保留了核心的代码实现，做下记录。

也希望顺便可以帮到其他类似需求的小伙伴。